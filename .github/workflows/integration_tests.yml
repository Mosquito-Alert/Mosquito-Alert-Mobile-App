name: Integration testing

on:
    push:

jobs:
    android:
        name: Run integration tests
        runs-on: ubuntu-latest
        strategy:
            matrix:
              api-level: [24, 29, 34]
        steps:
        - uses: actions/checkout@v4

        - uses: kuhnroyal/flutter-fvm-config-action/setup@v3

        - name: Get Dependencies
          run: flutter pub get
    
        - name: Decode google-services.json
          run: echo $GOOGLE_SERVICES_JSON | base64 --decode > android/app/google-services.json
          env:
            GOOGLE_SERVICES_JSON: ${{ secrets.GOOGLE_SERVICES_JSON_ANDROID_BASE64 }}

        - name: Enable KVM group perms
          run: |
            echo 'KERNEL=="kvm", GROUP="kvm", MODE="0666", OPTIONS+="static_node=kvm"' | sudo tee /etc/udev/rules.d/99-kvm4all.rules
            sudo udevadm control --reload-rules
            sudo udevadm trigger --name-match=kvm

        - name: Run integration tests
          uses: reactivecircus/android-emulator-runner@v2
          with:
            api-level: ${{ matrix.api-level }}
            target: google_apis
            arch: x86_64
            profile: Nexus 6
            script: "flutter test integration_test/dummy_test.dart"


#    ios:
#        strategy:
#            matrix:
#              device:
#                - "iPhone 15"
#                - "iPhone 16"
#            fail-fast: false
#        runs-on: macos-latest
#        steps:
#          - name: "Start Simulator"
#            uses: futureware-tech/simulator-action@v4
#            with:
#              model: ${{ matrix.device }}
#              erase_before_boot: true
#              shutdown_after_job: true
#
#          - uses: actions/checkout@v4
#
#          - uses: kuhnroyal/flutter-fvm-config-action/setup@v3
#
#          - name: Decode GoogleService-Info.plist secrets
#            env:
#              GOOGLESERVICES_INFO_PLIST_JSON: ${{ secrets.GOOGLESERVICE_INFO_PLIST_IOS_BASE64 }}
#            run: |
#              echo $GOOGLESERVICES_INFO_PLIST_JSON | base64 --decode > ios/Runner/GoogleService-Info.plist
#    
#          - run: flutter pub get
#
#          - name: "Run Flutter tests"
#            run: "flutter test integration_test/dummy_test.dart -v"
#